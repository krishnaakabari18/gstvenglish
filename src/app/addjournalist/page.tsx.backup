'use client';

import React, { useState, useEffect, useRef } from 'react';
import Image from 'next/image';
import { API_ENDPOINTS } from '@/constants/api';
import Script from 'next/script';
import ProFooter from '@/components/ProFooter';

interface FormData {
  name: string;
  title: string;
  description: string;
  city: string;
  agree_status: boolean;
}

const AddJournalistPage: React.FC = () => {
  const [formData, setFormData] = useState<FormData>({
    name: '',
    title: '',
    description: '',
    city: '',
    agree_status: false,
  });

  const [imageArray, setImageArray] = useState<File[]>([]);
  const [videoFile, setVideoFile] = useState<File | null>(null);
  const [loading, setLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);
  const [submitMessage, setSubmitMessage] = useState<string>('');
  const [errorMessage, setErrorMessage] = useState<string>('');
  const [imageLimitMsg, setImageLimitMsg] = useState<string>('');
  const [videoLimitMsg, setVideoLimitMsg] = useState<string>('');
  const agreeText = 'હું સંમત છું કે મારા દ્વારા અપલોડ કરવામાં આવતી સામગ્રી સંપૂર્ણપણે સત્ય અને વાસ્તવિક છે. જો કોઈ પણ પ્રકારની ખોટી માહિતી મળશે તો તેની સંપૂર્ણ જવાબદારી મારી રહેશે.';

  const imageInputRef = useRef<HTMLInputElement>(null);
  const videoInputRef = useRef<HTMLInputElement>(null);
  const editorRef = useRef<any>(null);

  // Initialize TinyMCE and jQuery Validate
  useEffect(() => {
    // Load TinyMCE
    const script = document.createElement('script');
    script.src = 'https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js';
    script.onload = () => {
      if (window.tinymce) {
        window.tinymce.init({
          selector: '#description',
          setup: function(editor: any) {
            editorRef.current = editor;
            editor.on('change', function() {
              window.tinymce.triggerSave();
              setFormData(prev => ({
                ...prev,
                description: editor.getContent()
              }));
            });
          },
          height: 300,
          menubar: false,
          plugins: [
            'advlist autolink lists link image charmap preview anchor',
            'searchreplace visualblocks code fullscreen',
            'insertdatetime media table paste code help wordcount'
          ],
          toolbar:
            'code | undo redo | bold italic underline strikethrough | fontsizeselect formatselect | ' +
            'alignleft aligncenter alignright alignjustify | numlist bullist | forecolor backcolor removeformat | ' +
            'fullscreen preview'
        });
      }
    };
    document.head.appendChild(script);

    return () => {
      if (window.tinymce) {
        window.tinymce.remove('#description');
      }
    };
  }, []);

  // Handle input changes
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value, type } = e.target;
    if (type === 'checkbox') {
      const checked = (e.target as HTMLInputElement).checked;
      setFormData(prev => ({
        ...prev,
        [name]: checked
      }));
    } else {
      setFormData(prev => ({
        ...prev,
        [name]: value
      }));
    }
  };

  // Handle image file changes
  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    const maxImages = 5;

    setImageLimitMsg('');

    if (imageArray.length + files.length > maxImages) {
      setImageLimitMsg('You can upload maximum 5 images.');
      return;
    }

    const newImages = [...imageArray];
    for (const file of files) {
      if (newImages.length >= maxImages) break;
      if (!file.type.startsWith('image/')) continue;
      newImages.push(file);
    }

    setImageArray(newImages);
    if (imageInputRef.current) {
      imageInputRef.current.value = '';
    }
  };

  // Handle video file change
  const handleVideoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0] || null;
    setVideoLimitMsg('');

    if (!file) {
      setVideoFile(null);
      return;
    }

    if (!['video/mp4', 'video/quicktime'].includes(file.type)) {
      setVideoLimitMsg('Only MP4 or MOV allowed.');
      if (videoInputRef.current) {
        videoInputRef.current.value = '';
      }
      setVideoFile(null);
      return;
    }

    if (file.size > 100 * 1024 * 1024) {
      setVideoLimitMsg('Video must not exceed 100MB.');
      if (videoInputRef.current) {
        videoInputRef.current.value = '';
      }
      setVideoFile(null);
      return;
    }

    setVideoFile(file);
  };

  // Remove image
  const removeImage = (index: number) => {
    const newImages = imageArray.filter((_, i) => i !== index);
    setImageArray(newImages);
  };

  // Remove video
  const removeVideo = () => {
    setVideoFile(null);
    if (videoInputRef.current) {
      videoInputRef.current.value = '';
    }
  };

  // Validation function
  const validateForm = (): boolean => {
    setError('');

    if (!formData.name.trim()) {
      setError('Please enter your name.');
      return false;
    }

    if (!formData.city.trim()) {
      setError('Please enter your city.');
      return false;
    }

    if (!formData.title.trim()) {
      setError('Please enter a title.');
      return false;
    }

    // Title word count validation (1-14 words)
    const titleWords = formData.title.trim().split(/\s+/).filter(Boolean);
    if (titleWords.length < 1 || titleWords.length > 14) {
      setError('Title must be between 1-14 words.');
      return false;
    }

    // Description validation
    const descriptionText = editorRef.current ?
      editorRef.current.getContent({ format: 'text' }).trim() :
      formData.description.replace(/<[^>]*>/g, '').trim();

    if (!descriptionText) {
      setError('Description is required.');
      return false;
    }

    // Description word count validation (10-150 words)
    const descriptionWords = descriptionText.split(/\s+/).filter(Boolean);
    if (descriptionWords.length < 10 || descriptionWords.length > 150) {
      setError('Description must be between 10-150 words.');
      return false;
    }

    // Media validation - at least 1 image or 1 video
    if (imageArray.length === 0 && !videoFile) {
      setError('Please upload at least 1 image or 1 video.');
      return false;
    }

    if (!formData.agree_status) {
      setError('You must agree before submitting.');
      return false;
    }

    return true;
  };

  // Handle form submission
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!validateForm()) {
      return;
    }

    try {
      setLoading(true);
      setError('');
      setSubmitMessage('');
      setErrorMessage('');

      // Create FormData for file upload
      const submitData = new FormData();
      submitData.append('name', formData.name);
      submitData.append('title', formData.title);

      // Get description from TinyMCE editor
      const description = editorRef.current ?
        editorRef.current.getContent() :
        formData.description;
      submitData.append('description', description);
      submitData.append('city', formData.city);
      submitData.append('agree_status', formData.agree_status ? '1' : '0');
      submitData.append('user_id', '85'); // Default user ID as shown in the API example

      // Add images
      imageArray.forEach((image) => {
        submitData.append('uploadimages[]', image);
      });

      // Add video if present
      if (videoFile) {
        submitData.append('uploadvideo', videoFile);
      }

      // Use the correct API endpoint for submitmarugujarat
      const response = await fetch(API_ENDPOINTS.JOURNALIST_SUBMIT, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: submitData,
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        setSubmitMessage('Journalist added successfully!');
        setTimeout(() => {
          window.location.href = '/journalist';
        }, 2000);
      } else {
        setErrorMessage('Failed to add Journalist. Please try again.');
      }

    } catch (err) {
      console.error('Error submitting journalist entry:', err);
      setErrorMessage('An error occurred. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  // Hide message after timeout
  const hideMessageAfterTimeout = (setter: React.Dispatch<React.SetStateAction<string>>, timeout = 2000) => {
    setTimeout(() => setter(''), timeout);
  };

  useEffect(() => {
    if (submitMessage) {
      hideMessageAfterTimeout(setSubmitMessage);
    }
    if (errorMessage) {
      hideMessageAfterTimeout(setErrorMessage);
    }
  }, [submitMessage, errorMessage]);

  return (
    <>
      <div className="container">
        <div className="row justify-content-center">
          <div className="col-lg-8 col-md-10 col-12">
            <div className="profilePage">
              <form className="formBox" id="news-form" encType="multipart/form-data" onSubmit={handleSubmit}>
                <div className="pNewsBox">
                  <div className="title">
                    <h2>એડ કરો</h2>
                  </div>

                  <div className="pnewsContent">
                {/* Submit Message */}
                {submitMessage && (
                  <div id="submit-message" className="submit-message mb-3 text-center">
                    {submitMessage}
                  </div>
                )}

                {/* Error Message */}
                {(errorMessage || error) && (
                  <div id="error-message" className="error-message mb-3 text-center">
                    {errorMessage || error}
                  </div>
                )}

                {/* Name Field */}
                <div className="row">
                  <div className="col-lg-12 mb-4">
                    <div className="lable">નામ</div>
                    <div className="inputOuter">
                      <input
                        type="text"
                        className="form-control"
                        id="name"
                        name="name"
                        value={formData.name}
                        onChange={handleInputChange}
                        placeholder="તમારું નામ દાખલ કરો"
                        required
                      />
                    </div>
                  </div>
                </div>

                {/* Title Field */}
                <div className="row">
                  <div className="col-lg-12 mb-4">
                    <div className="lable">સમાચાર ટાઇટલ</div>
                    <div className="inputOuter">
                      <input
                        type="text"
                        className="form-control"
                        id="title"
                        name="title"
                        value={formData.title}
                        onChange={handleInputChange}
                        placeholder="Enter your title"
                        required
                      />
                    </div>
                  </div>
                </div>

                {/* Description Field */}
                <div className="row">
                  <div className="col-lg-12 mb-4">
                    <div className="lable">ડિસ્ક્રીપ્શન</div>
                    <div className="inputOuter">
                      <textarea
                        className="tinymce-editor form-control"
                        id="description"
                        name="description"
                        value={formData.description}
                        onChange={handleInputChange}
                        required
                      />
                    </div>
                  </div>
                </div>

                {/* City Field */}
                <div className="row">
                  <div className="col-lg-12 mb-4">
                    <div className="lable">શહેર</div>
                    <div className="inputOuter">
                      <input
                        type="text"
                        className="form-control"
                        id="city"
                        name="city"
                        value={formData.city}
                        onChange={handleInputChange}
                        placeholder="Enter your City"
                        required
                      />
                    </div>
                  </div>
                </div>

                {/* Images Upload */}
                <div className="row">
                  <div className="col-lg-12 mb-4">
                    <div className="lable">તસવીરો (min 1, max 5 image upload)</div>
                    <div className="inputOuter">
                      <input
                        type="file"
                        className="form-control"
                        id="uploadimages"
                        name="uploadimages[]"
                        ref={imageInputRef}
                        multiple
                        accept="image/*"
                        onChange={handleImageChange}
                      />
                      {imageLimitMsg && (
                        <p className="field-error" style={{ display: 'block' }}>
                          {imageLimitMsg}
                        </p>
                      )}

                      {/* Image Preview */}
                      <div id="image-preview" className="row">
                        {imageArray.map((file, index) => (
                          <div key={index} className="col-6 col-md-2 thumbOuter" id={`img-${index}`}>
                            <Image
                              src={URL.createObjectURL(file)}
                              className="img-thumbnail"
                              style={{ width: '100%', height: '80px', objectFit: 'cover' }}
                              alt={`Preview ${index}`}
                              width={100}
                              height={80}
                            />
                            <button
                              type="button"
                              className="btn btn-danger btnRemove"
                              style={{ marginTop: '6px' }}
                              onClick={() => removeImage(index)}
                            >
                              <i className="fa fa-trash"></i>
                            </button>
                          </div>
                        ))}
                      </div>
                      <div id="image-error"></div>
                    </div>
                  </div>
                </div>

                {/* Video Upload */}
                <div className="row">
                  <div className="col-lg-12 mb-4">
                    <div className="lable">વીડિયો (optional, only mp4/mov, ≤ 100MB)</div>
                    <div className="inputOuter">
                      <input
                        type="file"
                        className="form-control"
                        id="uploadvideo"
                        name="uploadvideo"
                        ref={videoInputRef}
                        accept="video/*"
                        onChange={handleVideoChange}
                      />
                      {videoLimitMsg && (
                        <p className="field-error" style={{ display: 'block' }}>
                          {videoLimitMsg}
                        </p>
                      )}

                      {/* Video Preview */}
                      <div id="video-preview" className="row">
                        {videoFile && (
                          <div className="col-12 col-md-4 thumbOuter">
                            <video
                              controls
                              className="img-thumbnail"
                              style={{ width: '100%', height: '120px' }}
                            >
                              <source src={URL.createObjectURL(videoFile)} type={videoFile.type} />
                            </video>
                            <button
                              type="button"
                              className="btn btn-danger btnRemove"
                              style={{ marginTop: '6px' }}
                              onClick={removeVideo}
                            >
                              <i className="fa fa-trash"></i>
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Agreement Checkbox */}
                <div className="row">
                  <div className="col-lg-12 mb-4">
                    <div className="agree-wrap">
                      <label className="agree-inline">
                        <input
                          type="checkbox"
                          id="agree_status"
                          name="agree_status"
                          checked={formData.agree_status}
                          onChange={handleInputChange}
                        />
                        <div className="agree_checkbox_height" dangerouslySetInnerHTML={{ __html: agreeText }} />
                      </label>
                    </div>
                    <div id="agree-error"></div>
                  </div>
                </div>

                {/* Submit Button */}
                <div className="profileBtn">
                  <button type="submit" className="btn-gstv" disabled={loading}>
                    {loading ? 'અપલોડ થઈ રહ્યું છે...' : 'અપલોડ'}
                  </button>
                </div>
              </div>
            </div>
          </form>
            </div>
          </div>
        </div>
      </div>

     

      {/* Loading Overlay */}
      {loading && (
        <div
          id="loader-overlay"
          style={{
            display: 'block',
            position: 'fixed',
            top: 0,
            left: 0,
            width: '100%',
            height: '100%',
            background: 'rgba(255,255,255,0.8)',
            zIndex: 9999,
            textAlign: 'center',
          }}
        >
          <div
            style={{
              position: 'absolute',
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)',
            }}
          >
            <div
              className="spinner-border text-danger"
              style={{ width: '3rem', height: '3rem' }}
              role="status"
            >
              <span className="sr-only">Loading...</span>
            </div>
            <p style={{ marginTop: '10px' }}>Please wait...</p>
          </div>
        </div>
      )}
    </>
  );
};

export default AddJournalistPage;
